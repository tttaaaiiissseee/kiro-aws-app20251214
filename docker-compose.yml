services:
  # フロントエンドサービス
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: ${BUILD_TARGET:-dev}
    ports:
      - "${FRONTEND_PORT:-3000}:${FRONTEND_INTERNAL_PORT:-3000}"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - REACT_APP_API_URL=${REACT_APP_API_URL:-http://localhost:8000}
      - REACT_APP_VERSION=${APP_VERSION:-1.0.0}
    volumes:
      # Development volumes (only mounted in dev mode)
      - ./frontend:/app:${VOLUME_MODE:-rw}
      - /app/node_modules
      - frontend_cache:/app/.vite
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - aws-study-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:${FRONTEND_INTERNAL_PORT:-3000}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "com.aws-study-app.service=frontend"
      - "com.aws-study-app.version=${APP_VERSION:-1.0.0}"

  # バックエンドサービス
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: ${BUILD_TARGET:-dev}
    ports:
      - "${BACKEND_PORT:-8000}:${BACKEND_INTERNAL_PORT:-8000}"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - DATABASE_URL=file:./prisma/dev.db
      - PORT=${BACKEND_INTERNAL_PORT:-8000}
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:3000}
      - UPLOAD_MAX_SIZE=${UPLOAD_MAX_SIZE:-5242880}
      - JWT_SECRET=${JWT_SECRET:-your-secret-key-change-in-production}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    volumes:
      # Development volumes (only mounted in dev mode)
      - ./backend:/app:${VOLUME_MODE:-rw}
      - /app/node_modules
      # Persistent data volumes
      - sqlite_data:/app/prisma
      - uploads_data:/app/uploads
      - backend_cache:/app/.cache
    depends_on:
      database:
        condition: service_completed_successfully
    networks:
      - aws-study-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:${BACKEND_INTERNAL_PORT:-8000}/api/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    labels:
      - "com.aws-study-app.service=backend"
      - "com.aws-study-app.version=${APP_VERSION:-1.0.0}"

  # データベース初期化サービス（SQLite用）
  database:
    image: alpine:latest
    command: |
      sh -c "
        echo 'Initializing database directory...'
        mkdir -p /data
        if [ ! -f /data/dev.db ]; then
          echo 'Creating new database file...'
          touch /data/dev.db
        fi
        chmod 666 /data/dev.db
        chown -R 1001:1001 /data
        echo 'Database initialization completed'
      "
    volumes:
      - sqlite_data:/data
    networks:
      - aws-study-network
    labels:
      - "com.aws-study-app.service=database"
      - "com.aws-study-app.version=${APP_VERSION:-1.0.0}"

  # リバースプロキシ（本番環境用）
  nginx:
    image: nginx:alpine
    ports:
      - "${NGINX_PORT:-80}:80"
      - "${NGINX_SSL_PORT:-443}:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - nginx_cache:/var/cache/nginx
      - nginx_logs:/var/log/nginx
    depends_on:
      - frontend
      - backend
    networks:
      - aws-study-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - "com.aws-study-app.service=nginx"
      - "com.aws-study-app.version=${APP_VERSION:-1.0.0}"
    profiles:
      - production

volumes:
  # データベース永続化
  sqlite_data:
    driver: local
    labels:
      - "com.aws-study-app.volume=database"
  
  # アップロードファイル永続化
  uploads_data:
    driver: local
    labels:
      - "com.aws-study-app.volume=uploads"
  
  # キャッシュボリューム
  frontend_cache:
    driver: local
    labels:
      - "com.aws-study-app.volume=frontend-cache"
  
  backend_cache:
    driver: local
    labels:
      - "com.aws-study-app.volume=backend-cache"
  
  nginx_cache:
    driver: local
    labels:
      - "com.aws-study-app.volume=nginx-cache"
  
  nginx_logs:
    driver: local
    labels:
      - "com.aws-study-app.volume=nginx-logs"

networks:
  aws-study-network:
    driver: bridge
    labels:
      - "com.aws-study-app.network=main"
    ipam:
      config:
        - subnet: 172.20.0.0/16